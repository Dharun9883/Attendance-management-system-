<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Madura Solution | Attendance</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box;font-family:Segoe UI,sans-serif}
body{
  margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#141e30,#243b55)
}
.card{
  width:420px;background:#fff;padding:25px;border-radius:16px;
  box-shadow:0 15px 35px rgba(0,0,0,.35);text-align:center
}
input,button{
  width:100%;padding:12px;margin-top:10px;border-radius:8px
}
button{border:none;color:#fff;font-size:15px;cursor:pointer}
.day{background:#1976d2}
.night{background:#0d47a1}
.out{background:#388e3c}
.mgr{background:#6a1b9a}
.excel{background:#2e7d32}
.hide{display:none}
.footer{margin-top:10px;font-size:12px;color:#777}
</style>
</head>

<body>
<div class="card">
  <h2>Madura Solution</h2>

  <input id="eid" placeholder="Employee ID">
  <input id="ename" placeholder="Employee Name">
  <input id="date" readonly>
  <input id="time" readonly>

  <button class="day" onclick="checkIn('Day')">‚òÄÔ∏è Day Check-In</button>
  <button class="night" onclick="checkIn('Night')">üåô Night Check-In</button>
  <button class="out" onclick="checkOut()">Check-Out</button>

  <hr>
  <input id="mpass" type="password" placeholder="Manager Password">
  <button class="mgr" onclick="managerLogin()">Manager Login</button>

  <div id="managerPanel" class="hide">
    <button class="excel" onclick="exportExcel()">‚¨áÔ∏è Download Attendance Excel</button>
  </div>

  <div class="footer">¬© 2026 Madura Solution</div>
</div>

<script>
/* ELEMENTS */
const eid   = document.getElementById("eid");
const ename = document.getElementById("ename");
const dateF = document.getElementById("date");
const timeF = document.getElementById("time");
const mpass = document.getElementById("mpass");
const managerPanel = document.getElementById("managerPanel");

/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCcdyU3qzwiYabU9Qrgc3yX2j0iPxEcQUQ",
  projectId: "cms-management-e28df"
});
const db = firebase.firestore();

/* LIVE DATE & TIME */
setInterval(()=>{
  const n = new Date();
  dateF.value = n.toLocaleDateString();
  timeF.value = n.toLocaleTimeString();
},1000);

/* DATE KEY */
function getDateKey(d){
  return d.toISOString().slice(0,10);
}

/* SHIFT VALIDATION (COMPANY RULES) */
function isShiftAllowed(shift){
  const h = new Date().getHours();

  // Day Shift: 09:00 AM ‚Äì 05:59 PM
  if(shift === "Day" && (h < 9 || h >= 18)){
    alert("‚ùå Wrong shift!\nDay shift allowed only from 9:00 AM to 6:00 PM");
    return false;
  }

  // Night Shift: 09:00 PM ‚Äì 05:59 AM
  if(shift === "Night" && h >= 6 && h < 21){
    alert("‚ùå Wrong shift!\nNight shift allowed only from 9:00 PM to 6:00 AM");
    return false;
  }

  return true;
}

/* CHECK IN */
function checkIn(shift){
  if(!eid.value || !ename.value){
    alert("Enter Employee ID & Name");
    return;
  }

  if(!isShiftAllowed(shift)) return;

  const now = new Date();
  let dateKey = getDateKey(now);

  if(shift==="Night" && now.getHours()<6){
    const d = new Date(now);
    d.setDate(d.getDate()-1);
    dateKey = getDateKey(d);
  }

  db.collection("attendance")
    .where("empId","==",eid.value)
    .where("dateKey","==",dateKey)
    .get()
    .then(snap=>{
      if(!snap.empty){
        alert("‚ö†Ô∏è Already checked in today");
        return;
      }

      db.collection("attendance").add({
        empId: eid.value,
        empName: ename.value,
        dateKey: dateKey,
        shift: shift,
        checkIn: now.getTime(),
        checkOut: null
      }).then(()=>{
        alert("‚úÖ Check-in successful");
      });
    });
}

/* CHECK OUT */
function checkOut(){
  if(!eid.value){
    alert("Enter Employee ID");
    return;
  }

  const now = new Date();
  let dateKey = getDateKey(now);

  if(now.getHours()<6){
    const d = new Date(now);
    d.setDate(d.getDate()-1);
    dateKey = getDateKey(d);
  }

  db.collection("attendance")
    .where("empId","==",eid.value)
    .where("dateKey","==",dateKey)
    .get()
    .then(snap=>{
      if(snap.empty){
        alert("‚ùå Not checked in today");
        return;
      }

      snap.forEach(doc=>{
        const data = doc.data();
        if(data.checkOut){
          alert("‚ö†Ô∏è Already checked out");
          return;
        }

        db.collection("attendance").doc(doc.id).update({
          checkOut: now.getTime()
        }).then(()=>{
          alert("‚úÖ Check-out successful");
        });
      });
    });
}

/* MANAGER LOGIN */
function managerLogin(){
  if(mpass.value === "Ms@2025"){
    managerPanel.classList.remove("hide");
    alert("‚úÖ Manager access granted");
  }else{
    alert("‚ùå Wrong password");
  }
}

/* EXPORT EXCEL */
function exportExcel(){
  db.collection("attendance").get().then(snapshot=>{
    let data = [];
    let i = 1;

    snapshot.forEach(doc=>{
      const x = doc.data();
      data.push({
        "S.No": i++,
        "Employee ID": x.empId,
        "Employee Name": x.empName,
        "Date": x.dateKey,
        "Shift": x.shift,
        "Check In": new Date(x.checkIn).toLocaleString(),
        "Check Out": x.checkOut ? new Date(x.checkOut).toLocaleString() : ""
      });
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Attendance");
    XLSX.writeFile(wb, "Attendance_Report.xlsx");
  });
}
</script>
</body>
</html>

